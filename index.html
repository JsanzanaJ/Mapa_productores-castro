<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Mapa Interactivo Productores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

  <style>
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
    #map { width: 100vw; height: 100vh; }

    .panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: #fff;
      padding: 12px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      width: 280px;
    }

    .panel h3 { margin: 0 0 8px 0; font-size: 15px; }
    .panel label { font-size: 12px; font-weight: 600; display: block; margin-top: 6px; }

    .panel input, .panel select, .panel button {
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
    }

    .panel button { cursor: pointer; background: #1f6feb; color: white; border: none; }
    .panel button.reset { background: #555; margin-top: 6px; }

    .contador { font-size: 12px; margin-top: 6px; color: #333; }

    .filter-toggle {
   position: absolute;
   top: 10px;
   left: 10px;
   z-index: 1100;
   background: #1f6feb;
   color: white;
   padding: 8px 12px;
   border-radius: 6px;
   cursor: pointer;
   font-size: 13px;
   box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.panel.collapsed {
  transform: translateX(-320px);
  transition: transform 0.25s ease;
}

.panel {
  transition: transform 0.25s ease;
}

  </style>
</head>
<body>

<div class="filter-toggle" onclick="togglePanel()">üîç Filtros</div>


<div class="panel collapsed" id="filterPanel">
  <h3>Filtros</h3>

  <label>Buscar texto</label>
  <input id="searchBox" type="text" placeholder="Ej: Castro, papa, Prodesal...">

  <label>Campo espec√≠fico</label>
  <select id="fieldSelect">
    <option value="">(todos)</option>
  </select>

  <label>Valor</label>
  <select id="valueSelect">
    <option value="">(todos)</option>
  </select>

  <button onclick="applyFilters()">Aplicar filtros</button>
  <button class="reset" onclick="resetFilters()">Reset</button>

  <div id="counter" class="contador"></div>
</div>

<div id="map"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
const map = L.map('map', { zoomControl: false }).setView([-42.6, -73.7], 9);
L.control.zoom({ position: 'bottomright' }).addTo(map);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
const satelital = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

osm.addTo(map);

const markers = L.markerClusterGroup();
let heatLayer = null;
let geojsonData = null;

const overlays = {
  "Puntos": markers
};

const layerControl = L.control.layers(
  {"Mapa": osm, "Satelital": satelital},
  overlays,
  { collapsed: false }
).addTo(map);


fetch("./puntos.geojson")
  .then(res => res.json())
  .then(data => {
    geojsonData = data;
    initFilters(data);
    renderData(data.features);
  });

function initFilters(data) {
  const fieldSelect = document.getElementById('fieldSelect');
  const keys = Object.keys(data.features[0].properties);

  keys.forEach(k => {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k;
    fieldSelect.appendChild(opt);
  });

  fieldSelect.addEventListener('change', updateValueSelect);
}

function updateValueSelect() {
  const field = document.getElementById('fieldSelect').value;
  const valueSelect = document.getElementById('valueSelect');
  valueSelect.innerHTML = '<option value="">(todos)</option>';

  if (!field) return;

  const values = new Set();

  geojsonData.features.forEach(f => {
    if (f.properties[field] !== null && f.properties[field] !== undefined) {
      values.add(String(f.properties[field]));
    }
  });

  [...values].sort().forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    valueSelect.appendChild(opt);
  });
}

function buildHeatmap(features) {

  const heatPoints = features
    .filter(f => f.geometry && f.geometry.coordinates)
    .map(f => {

      const lat = f.geometry.coordinates[1];
      const lng = f.geometry.coordinates[0];

      let intensidad = parseFloat(
        String(f.properties["Superficie total afectada (%)"])
          .replace(",", ".")
      );

      if (isNaN(intensidad)) intensidad = 0;

      return [lat, lng, intensidad / 100];
    });

  if (heatLayer) {
    map.removeLayer(heatLayer);
    layerControl.removeLayer(heatLayer);
  }

  heatLayer = L.heatLayer(heatPoints, {
    radius: 30,
    blur: 20,
    maxZoom: 13,
    minOpacity: 0.35
  });

  layerControl.addOverlay(heatLayer, "Mapa de calor (%)");
}


function renderData(features) {
  markers.clearLayers();

  features.forEach(feature => {
    const layer = L.geoJSON(feature, {
      onEachFeature: function(feature, layer) {

        let popup = "<div style='max-height:300px; overflow-y:auto; font-size:13px'>";
        popup += "<b>Informaci√≥n del predio</b><br><br>";

        for (const key in feature.properties) {
          popup += `<b>${key}:</b> ${feature.properties[key]}<br>`;
        }

        popup += "</div>";
        layer.bindPopup(popup, { autoPan: false });
      }
    });

    markers.addLayer(layer);
  });

  map.addLayer(markers);
  document.getElementById('counter').innerHTML = `Mostrando <b>${features.length}</b> puntos`;

  buildHeatmap(features);
}

function applyFilters() {
  const text = document.getElementById('searchBox').value.toLowerCase();
  const field = document.getElementById('fieldSelect').value;
  const value = document.getElementById('valueSelect').value;

  const filtered = geojsonData.features.filter(f => {
    let ok = true;

    if (text) {
      ok = Object.values(f.properties).some(v =>
        String(v).toLowerCase().includes(text)
      );
    }

    if (ok && field && value) {
      ok = String(f.properties[field]) === value;
    }

    return ok;
  });

  renderData(filtered);
}

function resetFilters() {
  document.getElementById('searchBox').value = "";
  document.getElementById('fieldSelect').value = "";
  document.getElementById('valueSelect').innerHTML = '<option value="">(todos)</option>';
  renderData(geojsonData.features);
}

function togglePanel() {
  document.getElementById("filterPanel").classList.toggle("collapsed");
}

</script>

</body>
</html>
